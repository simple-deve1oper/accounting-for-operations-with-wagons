# Задание

Реализовать ИС учета операций с вагонами на предприятии. В ИС должны быть реализованы следующие операции:
- Операция приема вагонов на предприятие. На входе список вагонов с учетом на какой путь станции данные вагоны принимаются. Вагоны могут приниматься только в конец состава.
- Операция перестановки вагонов внутри станции. На входе список вагонов и путь на который они будут перемещены. Вагоны могут быть перемещены только в начало или конец состава.
- Операция убытия вагонов на сеть РЖД. Вагоны могут убывать только с начала состава.

В системе должны быть реализованы следующие справочники:
- Паспорт вагонов (Номер, Тип, Вес тары, Грузоподъемность)
- Станционная модель (Станции, Пути станций)
- Натурный лист для приема вагонов (Список вагонов с атрибутами: Порядковый номер, Номер вагона, Номенклатура груза, Вес груза в вагоне, Вес вагона)
- Справочник номенклатур грузов (Код груза, Наименование груза)

Для каждой сущности должен быть реализован **RestController** содержащий все CRUD операции.

## Технические требования
- Взаимодействие с БД с помощью Spring Data Jpa
- БД Oracle/Postgress
- Для контроллеров Spring Web. Реализовать аутентификацию/авторизацию (Basic будет достаточно). Подключить swagger
- Логирование с помощью logback
- Покрытие unit тестами не менее 50%

# Запуск приложения
Для запуска приложения необходимо заполнить **url**, **username** и **password** вашей PostgreSQL в файле **application.yml**. Создание таблиц происходит с помощью Flyway -> для дополнительной функциональности плагин можно настроить в файле **pom.xml** (необходимые строки закомментированы)

Для доступа к Swagger необходимо перейти по адресу <http://localhost:8080/swagger-ui.html>

Логирование информации с помощью logback записывается в файл **application.log**. Настройки Для этого описаны в файле **application.yml**.
Также с помощью библиотеки SLF4J логгируется класс **ExceptionApiHandler** для обработки исключений во время выполнения приложения.

# Запуск тестов и сборка приложения
В терминале, находясь в директории проекта, необходимо ввести следующую команду:
    
    mvn clean package

# Реализация
1. **Операция приема вагонов на предприятие**. Для реализации этой операции в контроллере **WagonAcceptanceCertificateController** создан POST метод **createDocuments(ReceptionDTO receptionDTO)**. Логика работы следующая:
    - Происходит проверка вагонов в ИС. Если хотя бы одного из переданных вагонов в объекте типа **ReceptionDTO** не существует, то срабатывает и обрабатывается исключение **EntityNotFoundException**
    - Происходит проверка вагонов на предприятии. Если хотя бы один из переданных вагонов в объекте типа **ReceptionDTO** уже стоит на предприятии, то срабатывает и обрабатывается исключение **EntityAlreadyExistsException**
    - При удачном прохождении двух предыдущих проверок из объекта типа **ReceptionDTO** создается список документов, в которых затем указывается порядковый номер каждого вагона. Для определения порядкового номера вагонов происходит вызов в БД для получения максимального порядкового номера вагона по заданному пути. Если в ответе значение **null** то установление порядкового номера вагонам начинается с единицы; иначе к полученному значению прибавляется единица и с этого значения начинается установление порядкового номера вагонам
2. **Операция перестановки вагонов внутри станции**. Для реализации этой операции в контроллере **WagonAcceptanceCertificateController** создан PUT метод **reorder(ChangeDTO changeDTO)**. Логика работы следующая:
    - Происходит проверка вагонов в ИС. Если хотя бы одного из переданных вагонов в объекте типа **ChangeDTO** не существует, то срабатывает и обрабатывается исключение **EntityNotFoundException**
    - Происходит проверка станций и путей между теми, которые были у вагонов и переданными в объекте типа **ChangeDTO**. 
        - Если хотя бы у одного вагона путь совпадает с путём из объекта типа **ChangeDTO**, то срабатывает и обрабатывается исключение **EntityValidationException**.
        - Если хотя бы у одного вагона станция пути отличается от станции пути из объекта типа **ChangeDTO**, то срабатывает и обрабатывается исключение **EntityValidationException**.
    - При удачном прохождении двух предыдущих проверок определяется куда будут расставлены вагоны: в начало или конец состава
        - Если значение **first** в объекте типа **ChangeDTO** является **true**, то происходит перезапись порядкого номера вагонов на переданном пути из объекта **ChangeDTO** начиная со значения **количество вагонов для перестановки + 1**, а переданные вагоны получают порядковый номер начиная с единицы
        - Если значение **first** в объекте типа **ChangeDTO** является **false**, то для определения порядкового номера вагонов происходит вызов в БД для получения максимального порядкового номера вагона по заданному пути. Если в ответе значение **null** то установление порядкового номера вагонам начинается с единицы; иначе к полученному значению прибавляется единица и с этого значения начинается установление порядкового номера вагонам
        - После перестановки вагонов на новый путь из объекта типа **ChangeDTO** происходит перезапись порядкового ноиера вагонов на старом пути, начиная с единицы
3. **Операция убытия вагонов на сеть РЖД**. Для реализации этой операции в контроллере **WagonAcceptanceCertificateController** создан PATCH метод **departure(Long pathwayId, Integer quantity)**. Логика работы следующая:
    - Получаем число вагонов по заданному пути из БД
        - Происходит проверка числа вагонов по заданному пути. Если вагонов по заданному пути нет, то срабатывает и обрабатывается исключение **EntityNotFoundException**
        - Происходит проверка на то, больше ли число запрашиваемых вагонов для убытия вагонов находящихся на предприятии по заданному пути. Если число запрашиваемых вагонов больше, то то срабатывает и обрабатывается исключение **InputErrorException**
        - При прохождении двух предыдущих проверок запрашиваемые количество вагонов из начала состава получают дату убытия вагонов, а оставшиеся вагоны на этом же пути перезаписывают порядковый номер, начиная с единицы

# Аутентификация и авторизация
Для авторизация и аутентификации используются следующие роли: **GUEST**, **MODERATOR** и **ADMIN**. Добавление новых пользователей, как и ролей, происходит через саму БД.

Создан контроллер панели администратора **AdminController** c единственным методом **PATCH /api/v1/admin/edit/role**, который позволяет изменять админитратору роль пользователя. К методу этого контроллера имеет доступ только пользователь с ролью **ADMIN**

# Описание методов справочника
1. Справочник **Паспорт вагонов** создан в виде контроллера **WagonPassportController**. Доступ к **GET** методам имеют все авторизованные пользователи, а ко всем остальным методам доступ имеют только пользователи с ролью **MODERATOR** или **ADMIN**. Доступ к данным о типе вагона сущности **Type** производятся только через саму БД.
    - **GET /api/v1/passport/all** - получение информации о всех вагонах
    - **GET /api/v1/passport/{number}** - получение информации о вагоне по номеру вагона
    - **POST /api/v1/passport/create** - cоздание записи о новом вагоне
    - **PUT /api/v1/passport/{number}/update** - обновление информации о существующем вагоне
    - **DELETE /api/v1/passport/{number}/delete** - удаление записи о вагоне по номеру вагона
2. Справочник **Станционная модель** создан в виде контроллера **StationModelController**. Доступ к **GET** методам имеют все авторизованные пользователи, а ко всем остальным методам доступ имеют только пользователи с ролью **MODERATOR** или **ADMIN**
    - **GET /api/v1/model/stations/all** - получение информации о всех станциях и их путей
    - **GET /api/v1/model/stations/{id}** - получение информации о станции и её путях по идентификатору станции
    - **POST /api/v1/model/stations/create** - cоздание новых записей станции и путей для неё
    - **PATCH /api/v1/model/stations/{id}/edit** - обновление наименования у существующей станции
    - **DELETE /api/v1/model/stations/{id}/delete** - удаление существующей станции по идентификатору станции
    - **POST /api/v1/model/pathways/create** - создание нового пути существующей станции
    - **DELETE /api/v1/model/pathways/{id}/delete** - удаление существующего пути по идентификатору пути
3. Справочник **Натурный лист для приема вагонов** создан в виде контроллера **WagonAcceptanceCertificateController**. Доступ к **GET** методам имеют все авторизованные пользователи, а ко всем остальным методам доступ имеют только пользователи с ролью **MODERATOR** или **ADMIN**
    - **GET /api/v1/documents/all** - получение информации о записях приема вагонов
    - **GET /api/v1/documents/{id}** - получение информации о записи приёма вагонов по идентификатору
    - **GET /api/v1/documents/{pathwayId}/pathway** - получение информации о записях приема вагонов по идентификатору пути, вагоны которых находятся на предприятии
    - **POST /api/v1/documents/create** - приём вагонов на предприятие
    - **PUT /api/v1/documents/reorder** - перестановка вагонов внутри станции
    - **PATCH /api/v1/documents/departure/{pathwayId}/pathway?quantity={quantity}** - убытие вагонов на сеть РЖД с пути по идентификатору пути в заданном количестве
    - **DELETE /api/v1/documents/{id}/delete** - удаление записи о листе приёма вагонов по идентификатору
4. Справочник **номенклатура грузов** создан в виде контроллера **CargoNomenclatureController**. Доступ к **GET** методам имеют все авторизованные пользователи, а ко всем остальным методам доступ имеют только пользователи с ролью **MODERATOR** или **ADMIN**
    - **GET /api/v1/cargos/all** - получение информации о всех грузах
    - **GET /api/v1/cargos/{id}** - получение информации о грузе по идентификатору
    - **POST /api/v1/cargos/create** - создание новой записи о грузе
    - **PATCH /api/v1/cargos/{id}/edit** - обновление наименования груза
    - **DELETE /api/v1/cargos/{id}/delete** - удаление записи о грузе